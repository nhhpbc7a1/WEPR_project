{{#section 'css'}}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
    integrity="sha512-nMNlpuaDPrqlEls3IX/Q56H36qvBASwb3ipuo3MxeWbsQB1881ox0cRv7UPTgBlriqoynt35KjEwgGUeUXIPnw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    label {
        font-weight: 500;
        font-size: 18px;
    }
</style>
{{/section}}
{{#section 'js'}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"
    integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

<script>
    // Khởi tạo CKEditor
    ClassicEditor
        .create(document.querySelector('#editor'), {
            ckfinder: {
                // Tùy chọn upload hình ảnh (nếu có server xử lý upload)
                uploadUrl: '/admin/article/upload-image'
            },
            toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'imageUpload', 'insertTable', 'mediaEmbed', 'undo', 'redo'],
            mediaEmbed: {
                previewsInData: true
            }
        })
        .then(editor => {
            editorInstance = editor;

            // Đổ dữ liệu cũ vào editor
            const oldContent = {{{ json article.content }}};
            editor.setData(oldContent);

            // Trước khi submit form, cập nhật dữ liệu CKEditor vào textarea ẩn
            document.querySelector('#frmEditArticle').addEventListener('submit', (e) => {
                e.preventDefault();
                document.querySelector('#form_edit_content').value = editorInstance.getData();
                document.querySelector('#frmEditArticle').submit();
            });
        })
        .catch(error => {
            console.error('Lỗi khi khởi tạo CKEditor:', error);
        });

</script>
<script>
    $(document).ready(function () {
        // Dữ liệu cấp 1 và cấp 2

        const parentCatData = {{{ json parent_categories }}}
        const categoriesLevel1 = parentCatData.map(item => ({
            id: item.category_id,             // ID cần cho Select2
            text: item.category_name,         // Text hiển thị trên Select2
            parent_category_id: item.parent_category_id // Thêm parent_category_id
        }));
        console.log(categoriesLevel1);

        const childCatData = {{{ json child_categories }}}
        // Tạo đối tượng categoriesLevel2
        const categoriesLevel2 = {};  // Giả định giá trị được chọn
        const selectedCategory1 = {{article.parent_category_id}}; // ID đã chọn cho cấp 1
        const selectedCategory2 = {{article.category_id}}; // ID đã chọn cho cấp 2

        // Lặp qua dữ liệu và nhóm theo parent_category_id
        childCatData.forEach(item => {
            // Nếu chưa có parent_category_id trong đối tượng categoriesLevel2, khởi tạo mảng
            if (!categoriesLevel2[item.parent_category_id]) {
                categoriesLevel2[item.parent_category_id] = [];
            }

            // Thêm đối tượng vào mảng theo parent_category_id
            categoriesLevel2[item.parent_category_id].push({
                id: item.category_id,    // ID của category
                text: item.category_name // Tên category
            });
        });

        // Khởi tạo Select2
        $('#category1').select2({
            data: categoriesLevel1
        }).val(selectedCategory1).trigger('change');;

        $('#category2').select2({
            placeholder: "-- Chọn cấp 2 --"
        });

        // Sự kiện khi thay đổi danh mục cấp 1
        $('#category1').on('change', function () {
            const selectedId = $(this).val();

            // Xóa và cập nhật danh mục cấp 2
            $('#category2').empty().trigger('change');

            if (categoriesLevel2[selectedId]) {
                $('#category2').select2({
                    data: categoriesLevel2[selectedId]
                });
                if (selectedId == selectedCategory1) {
                    $('#category2').val(selectedCategory2).trigger('change');
                }

            }
        });
        $('#category1').trigger('change');
    });
</script>
{{/section}}
<div class="container-fluid" style="padding: 40px;">
    <div class="row">
        <div class="col-12">
            <div class="card info_part">
                <div class="card-header">
                    <h4>Add Article</h4>
                </div>
                <div class="card-body">

                    <div class="container mt-3" style="margin-bottom: 100px;">
                        <form id="frmEditArticle" action="" method="post" enctype="multipart/form-data">

                            <div class="form-group">
                                <label>ID</label>
                                <input type="text" name="article_id" required class="form-control" value="{{article.article_id}}" readonly><br><br>
                            </div>

                            <div class="form-group">
                                <label>Tiêu đề:</label>
                                <input type="text" name="title" required class="form-control" value="{{article.title}}"><br><br>
                            </div>
                            {{!-- <div class="form-group">
                                <label>Tác giá</label>
                                <input type="text" name="author" required class="form-control"><br><br>
                            </div> --}}
                            <div class="form-group">
                                <label>Tóm tắt:</label>
                                <textarea name="abstract" rows="3" required class="form-control">{{article.abstract}}</textarea><br><br>
                            </div>

                            <label>Nội dung:</label>
                            <div id="editor"></div><br>


                            <div class="form-group mt-5">
                                <label>Danh mục:</label>
                                <select id="category1" style="width: 200px;" class="form-control">
                                    <option value="">-- Chọn cấp 1 --</option>
                                </select>
                                <select id="category2" style="width: 200px;" class="form-control" name="category_id">
                                    <option value="">-- Chọn cấp 2 --</option>
                                </select>
                            </div>

                            <div class="form-group mt-3">
                                <label for="isPremium">
                                    Is premium
                                </label>
                                <input type="checkbox" name="is_premium" id="isPremium" 
                                {{#ifEquals article.is_premium 1}}checked{{/ifEquals}}>
                                <!-- Thêm thẻ input ẩn để gửi giá trị false nếu checkbox không được chọn -->
                            </div>

                            <div class="mt-5">
                                <a name="" id="" class="btn btn-outline-success" href="/admin/article" role="button">
                                    <i class="bi bi-skip-backward-fill"></i>
                                    List
                                </a>

                                <button type="submit" class="btn btn-primary">
                                    Save
                                </button>

                                <a name="" id="" class="btn btn-danger" href="/admin/article/del?id={{article.article_id}}" role="button">
                                    <i class="bi bi-trash"></i>
                                    Delete
                                </a>


                            </div>

                            <!-- Thẻ textarea ẩn để lưu dữ liệu từ CKEditor -->
                            <textarea id="form_edit_content" name="content" style="display:none;"></textarea>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>